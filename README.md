# BOLD Taxdump Builder

Build NCBI-style taxonomy databases and marker-specific FASTA reference sets
from BOLD public database snapshots.

## Overview
This pipeline converts BOLD DNA Barcode Reference Library public TSV snapshots
into:

- `nodes.dmp` and `names.dmp` (NCBI-compatible taxonomy)
- `taxid.map` (processid -> TaxID)
- marker-specific FASTA files (COI-5P, ITS, 16S, etc.)

These outputs are directly usable by Kraken2, Centrifuge, Kaiju,
DIAMOND+MEGAN, MMseqs2, and other taxonomic classifiers.

## Why this exists
BOLD is the world's largest curated DNA barcode reference library, but it is
released as periodic snapshot exports rather than classifier-ready taxdump
packages. This project provides a reproducible pipeline that converts any
public BOLD snapshot into a complete taxonomic reference set.

## Outputs
After running the pipeline on a BOLD snapshot you will have:

```
bolddb-taxdump/
  nodes.dmp
  names.dmp
  taxid.map        (processid -> TaxID)

marker_fastas/
  COI-5P.fasta
  ITS.fasta
  16S.fasta
  ...

artifacts/
  bolddb-taxdump.<snapshot>.zip
  marker_fastas.<snapshot>.zip
  manifest.json
  SHA256SUMS.txt
```
The `manifest.json` includes the snapshot ID, commit hash, and counts.
Release artifacts are created only when you pass `--package` or run scripts
04-06 manually. Manifest and checksums can be skipped with flags.

## Data policy
Large data artifacts generated by this pipeline are not committed to GitHub;
they are published under GitHub Releases.

## How taxonomy is constructed
The taxonomic backbone is built from the fields provided in the BOLD snapshot:

`kingdom -> phylum -> class -> order -> family -> subfamily -> tribe -> genus -> species`

Missing data rules:

- Missing intermediate ranks are skipped.
- If species is missing but genus exists, a stable BIN-aware label is created:
  - `Genus sp. BOLD:XXXXXXX` (if BIN exists)
  - `Genus sp. PROCESSID` (otherwise)
- If genus is missing, the record is attached to the deepest available rank.
- No artificial "Unidentified" taxa are created.
- Each sequence is attached as a leaf node using its BOLD processid.

## Requirements
- Bash
- awk (gawk)
- TaxonKit (>= 0.16)
- zip
- sha256sum or shasum (for checksums)

## Quick start
Download a public BOLD snapshot, for example:

```
BOLD_Public.26-Sep-2025/BOLD_Public.26-Sep-2025.tsv
```

Run the full pipeline:

```bash
bash bolddb-taxdump.sh \
  BOLD_Public.26-Sep-2025/BOLD_Public.26-Sep-2025.tsv
```

Note: BOLD snapshots are very large; processing can take a long time.

If you prefer to run it as an executable, set the bit once:

```bash
chmod +x bolddb-taxdump.sh
./bolddb-taxdump.sh BOLD_Public.26-Sep-2025/BOLD_Public.26-Sep-2025.tsv
```

This will produce:

```
bolddb-taxdump/
marker_fastas/
```

To generate release artifacts (zips, manifest, checksums), add `--package`:

```bash
bash bolddb-taxdump.sh \
  --input BOLD_Public.26-Sep-2025/BOLD_Public.26-Sep-2025.tsv \
  --package
```

With `--package`, you will also get:

```
artifacts/
```

## Detailed workflow
`bolddb-taxdump.sh` runs the pipeline in this order:

1) Extracts taxonomy fields from the BOLD TSV into `taxonkit_input.tsv`.
2) Builds an NCBI-style taxdump (`nodes.dmp`, `names.dmp`, `taxid.map`).
3) Splits sequences into per-marker FASTA files in `marker_fastas/`.
4) Packages `bolddb-taxdump/` and `marker_fastas/` into versioned zip files (when `--package` is set).
5) Generates `artifacts/manifest.json` (when `--package` is set).
6) Writes `artifacts/SHA256SUMS.txt` (when `--package` is set).

You can skip the manifest and/or checksums (only applies when using `--package`):

```bash
bash bolddb-taxdump.sh \
  --input BOLD_Public.26-Sep-2025/BOLD_Public.26-Sep-2025.tsv \
  --package \
  --skip-manifest \
  --skip-checksums
```

The script also accepts positional arguments in this order:

`input_tsv taxonkit_input taxdump_dir marker_dir artifacts_dir`

## Scripted steps
Workflow scripts live in `scripts/`:

- `scripts/01_extract_taxonomy_from_bold.sh`: build `taxonkit_input.tsv`
- `scripts/02_build_ncbi_taxdump.sh`: generate `bolddb-taxdump/`
- `scripts/03_build_marker_fastas.sh`: produce per-marker FASTA files
- `scripts/04_package_reference_db.sh`: zip `bolddb-taxdump/` and `marker_fastas/`
- `scripts/05_generate_checksums.sh`: generate `SHA256SUMS.txt`
- `scripts/06_generate_manifest.sh`: generate `manifest.json`

Example (manual run):

```bash
bash scripts/01_extract_taxonomy_from_bold.sh \
  BOLD_Public.26-Sep-2025/BOLD_Public.26-Sep-2025.tsv \
  taxonkit_input.tsv

bash scripts/02_build_ncbi_taxdump.sh \
  taxonkit_input.tsv \
  bolddb-taxdump

bash scripts/03_build_marker_fastas.sh \
  BOLD_Public.26-Sep-2025/BOLD_Public.26-Sep-2025.tsv \
  marker_fastas

bash scripts/04_package_reference_db.sh \
  artifacts \
  bolddb-taxdump \
  marker_fastas \
  BOLD_Public.26-Sep-2025

bash scripts/05_generate_checksums.sh \
  artifacts \
  artifacts/SHA256SUMS.txt

bash scripts/06_generate_manifest.sh \
  artifacts \
  bolddb-taxdump \
  marker_fastas \
  BOLD_Public.26-Sep-2025 \
  artifacts/manifest.json

```

## Working with multiple BOLD releases
This pipeline is designed to be rerun on any BOLD public snapshot, for example:

- `BOLD_Public.2023-xx`
- `BOLD_Public.2024-xx`
- `BOLD_Public.2025-xx`

Each snapshot will produce its own taxdump, marker FASTAs, and release
artifacts, enabling longitudinal comparisons of taxonomy, BINs, and reference
coverage.

## Prebuilt databases (GitHub Releases)
Large files are not stored in Git. Prebuilt databases built from specific BOLD
snapshots are published under GitHub Releases as:

- `bolddb-taxdump.<snapshot>.zip`
- `marker_fastas.<snapshot>.zip`
- `manifest.json`
- `SHA256SUMS.txt`

Each release should document the BOLD snapshot used and the pipeline commit
hash to support reproducibility.

## Data citation
If you use these databases, cite the BOLD snapshot you used, for example:

BOLD DNA Barcode Reference Library
Release 26-SEP-2025
https://doi.org/10.5883/DP-BOLD_Public.26-Sep-2025

## License
The code in this repository is licensed under the MIT License.

This repository does not redistribute BOLD data. BOLD data remain subject to
BOLD's own terms of use and citation requirements.
